---
layout:     post
title:      "PLSQL"
subtitle:   "PLSQL的基本使用"
date:       2019-01-03 22:00:00
author:     "LQFGH"
header-img: "img/post-bg-web.jpg"
header-mask: 0.3
catalog:    true
tags:
  - Oracle
  - plsql
---
以下例子都使用SQL\*PLUS进行编写
在使用之前需要先运行`set serveroutput on` 设置SQL\*PLUS的环境参数 SERVEROUTPUT 为 on，否则看不到程序输出的结果。
***


## PL/SQL的基本语法


#### **变量命名**

变量命名在 PL/SQL 中有特别的讲究，建议在系统的设计阶段就要求所有编程人员共同遵守一定的要求， 
使得整个系统的文档在规范上达到要求。下面是 建议的命名方法：

| 标识符      | 命名规则            | 例子              |
| -------- | --------------- | --------------- |
| 程序变量     | V_name          | V_name          |
| 程序常量     | C_Name          | C_company_name  |
| 游标变量     | Name_cursor     | Emp_cursor      |
| 异常标识     | E_name          | E_too_many      |
| 表类型      | Name_table_type | Emp_record_type |
| 表        | Name_table      | Emp_record_type |
| 记录类型     | Name_record     | Emp_record      |
| SQL*Plus | 替代变量            | P_name  P_sal   |
| 绑定变量     | G_name          | G_year_sal      |


#### **基本结构**

PL/SQL 程序由三部分组成，即申明部分、执行部分、异常处理部分。
结构如下：
```sql
DECLARE
/*  声明部分 :  在此声明 PL/SQL 用到的变量 , 类型及游标，以及局部的存储过程和函数 */
BEGIN
/* 执行部分 : 过程及 SQL  语句 ,  即程序的主要部分 */
EXCEPTION
/*  执行异常部分 :  错误处理 */
END;
```

#### **基本用法**
其中declare和exception部分不需要时可以不写，但是begin和end是必不可少的部分。
```sql
DECLARE
	v_sal number(20);
	v_email varchar2(20);
	v_name varchar(20);
BEGIN 
	select salary,email,last_name into v_sal,v_email,v_name from employees where 					employee_id 			= 100;
    -- plsql输出语句
	dbms_output.put_line(v_sal||' '||v_email||' '||v_name);
--EXCEPTION
END;

```

动态获取表中字段的变量类型
```sql
DECLARE
	v_sal employees.salary%type;
	v_email employees.email%type;
	v_name employees.last_name%type;
BEGIN 
	select salary,email,last_name into v_sal,v_email,v_name from employees where 					employee_id 			= 100;
	dbms_output.put_line(v_sal||' '||v_email||' '||v_name);
END;
```

***


## PL/SQL的记录类型

记录类型是把 逻辑相关 的数据作为一个单元存储起来 ，称作 PL/SQL RECORD 的域(FIELD) ，其作用是存
放互不相同但逻辑相关的信息。

#### **定义记录类型语法如下**
```sql
TYPE record_type IS RECORD(
Field1 type1 [NOT NULL] [:= exp1 ],
Field2 type2 [NOT NULL] [:= exp2 ],
. . . . . .
Fieldn typen [NOT NULL] [:= expn ] ) ;
```

#### **举例**
```sql
DECLARE
  TYPE emp_record is record(
			v_sal employees.salary%type,
			v_email employees.email%type,
			v_name employees.last_name%type
	);
	--定义一个记录类型的变量
	v_emp_record emp_record;
BEGIN 
-- 按照记录类型中定义变量的顺序将查出来的值放入记录类型中
  select salary,email,last_name into v_emp_record from employees where employee_id = 100;
  -- 分别打印记录类型中的变量
  dbms_output.put_line(v_emp_record.v_sal||' '||v_emp_record.v_email||' '||v_emp_record.v_name);
END;
```

#### **变量赋值**

> 在 PL/SQL 编程中，变量赋值是一个值得注意的地方，它的语法如下：
> variable := expression ;
> variable 是一个 PL/SQL 变量, expression 是一个 PL/SQL 表达式.

```sql
DECLARE
    TYPE salary_record IS RECORD(
         v_name VARCHAR(20),
         v_salary NUMBER(8,2)
    );
    v_salary_record salary_record;
BEGIN 
    v_salary_record.v_name := '华仔';
    v_salary_record.v_salary := 200000;
    dbms_output.put_line( v_salary_record.v_name||'  '||  v_salary_record.v_salary);
END; 

```

#### **使用%ROWTYPE**

PL/SQL 提供%ROWTYPE  操作符,  返回一个记录类型,  其数据类型和数据库表的数据结构相一致。
使用%ROWTYPE 特性的优点在于：

* 所引用的数据库中列的个数和数据类型可以不必知道；
* 所引用的数据库中列的个数和数据类型可以实时改变。

```sql
DECLARE
  	v_emp_record employees%ROWTYPE;
		
BEGIN 
	  SELECT * INTO v_emp_record FROM employees WHERE employee_id = 100;
		dbms_output.put_line( v_emp_record.last_name||'  '||	v_emp_record.salary);
END;
```

#### **更新操作**

其实和查询只是sql语句之间的区别，但是这里还是放一个例子

```sql
DECLARE
    v_emp_id NUMBER(10);
    
BEGIN 
    v_emp_id :=100;
    UPDATE employees e
    SET e.salary = e.salary + 100
    WHERE e.employee_id = v_emp_id;
    
    dbms_output.put_line('执行成功！');
END;  

```

> 删除和插入这里就不列出来了，都只是sql上的区别，用法是一样的



## PL/SQL流程控制语句

介绍 PL/SQL 的流程控制语句, 包括如下三类:
* 控制语句: IF 语句
* 循环语句: LOOP 语句, EXIT 语句
* 顺序语句: GOTO 语句, NULL 语句
* 

#### **条件语句**

###### 条件语句的基本用法

```sql
IF <布尔表达式> THEN
	PL/SQL 和 SQL 语句;
ELSIF < 其它布尔表达式> THEN
	其它语句;
ELSIF < 其它布尔表达式> THEN
	其它语句;
ELSE
	其它语句;
END IF;
```

###### 举例

```sql
DECLARE
    v_sal employees.salary%TYPE;
		v_msg VARCHAR2(20);
BEGIN 
	  SELECT e.salary INTO v_sal FROM employees e WHERE e.employee_id = 100;  
		
		IF v_sal >= 1000 THEN v_msg := '工资大于10000';
		ELSIF v_sal < 10000 AND v_sal > 6000 THEN  v_msg := '工资大于6000小于10000';
		ELSE  v_msg := '工资小于6000';
		END IF;
		dbms_output.put_line(v_msg);
		
END;
```